<!DOCTYPE html>
<html>
  <head>
    <title>MathWeave</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/code.css">
    <link rel="stylesheet" href="css/commandline.css">
    <meta charset="utf-8" />
  </head>
  <body>
    <div id="page">
      <a href="/" class="selected">Home</a>
      <a href="/history.html">History</a>
      <a href="/feed.html">Feed</a>
      <div class="right">
        <div class="header" style="position: relative">
          <h1 style="padding: 0; margin:0; width: 20%; float:left">MathWeave</h1>
          <div style="float: right;" id="address">
            <b>Key File</b><br/>
            <input id="keyFile" type="file" placeholder="Arweave Key File" style="float:left; width: 300px"/>
            <button id="upload" class="eval" style="float:left">Submit</button>
          </div>
          <div style="clear:both;"></div>
        </div>
        <div style="clear:both;"></div>
        <div id="commandline">loading...</div>
        <div class="tips">
          Shortcut keys:
          <ul>
            <li>Press <b>S</b> to set focus to the input field</li>
            <li>Press <b>Ctrl+F11</b> to toggle full screen</li>
            <li>Enter <b>"clear"</b> to clear history</li>
          </ul>
        </div>
        <div id="message">

        </div>
        <div id="buttons">
          <button class="eval" id="save">Save results</button>
        </div>
      </div>
    </div>
    <script src="js/es5-shim.min.js" type="text/javascript"></script>
    <script src="js/es5-sham.min.js" type="text/javascript"></script>
    <script src="js/math.js"></script>
    <script src="js/commandline.js"></script>
    <script src="https://unpkg.com/arweave/bundles/web.bundle.js"></script>
    <script>
      const arweave = Arweave.init({
        host: 'arweave.net',
        port: 443,
        protocol: 'https',
        timeout: 20000,
        logging: false
      });

      if (localStorage.getItem('address')!== null) {
        document.getElementById('address').innerHTML = localStorage.getItem('address');
        document.getElementById('buttons').style.display = 'grid';
      }

      // arweave save data
      async function saveReplData() {
        var key = await JSON.parse(localStorage.getItem('key'));
        var data = document.querySelector('.results').innerHTML || 'nothing to see here';
        let transaction = await arweave.createTransaction({
          data: data,
        }, key);

        transaction.addTag('arweaveapp', 'arweavemathrepl');

        await arweave.transactions.sign(transaction, key);
        const response = await arweave.transactions.post(transaction);

        console.log(response.status);
        if (response.status === 200) {
          document.getElementById('message').innerHTML = '<h1>Successfully saved your <span><a href="/history.html">data</a></span></h1>';
          setInterval(function(){
            document.getElementById('message').innerHTML = '';
          }, 20000);
        }
        document.querySelector('.results').innerHTML = ''
      }

      // arweave get wallet and save to localStorage
      async function getWalletAddress(keyFileData) {
        var wallet_file = await JSON.parse(keyFileData);
        arweave.wallets.jwkToAddress(wallet_file).then((address) => {
          document.getElementById('address').innerHTML = address;
          if (typeof(Storage) !== 'undefined') {
            localStorage.setItem('address', address);
            localStorage.setItem('key', keyFileData);
          } else {
            console.log('Web Storage is not supported!');
          }
        });
      }

      // click event handlers
      if (document.getElementById('upload')) {
        var uploadbtn = document.getElementById('upload');
        uploadbtn.onclick = function(event) {
          var file = document.getElementById('keyFile');
          var fr = new FileReader();
          fr.onload = function() {
            getWalletAddress(fr.result);
            document.getElementById('buttons').style.display = 'grid';
          };
          fr.readAsText(file.files[0]);
        }
      } 

      if (document.getElementById('save')) {
        var savebtn = document.getElementById('save');
        savebtn.onclick = async function(event) {
          savebtn.innerHTML = 'Saving...';
          await saveReplData();
          savebtn.innerHTML = 'Save';
        }
      }
    </script>
  </body>
</html>
