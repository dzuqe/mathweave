<!DOCTYPE html>
<html>
  <head>
    <title>Arweave Math REPL</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/code.css">
    <link rel="stylesheet" href="css/commandline.css">
  </head>
  <body>
    <div id="page">
      <div class="right">
        <div class="header" style="position: relative">
          <h1 style="padding: 0; margin:0; width: 20%; float:left">Arweave Math REPL</h1>
          <div style="float: right;" id="address">
            <input id="keyFile" type="file" placeholder="Arweave Key File" style="float:left; width: 300px"/>
            <button id="upload" class="eval" style="float:left">Submit</button>
          </div>
          <div style="clear:both;"></div>
        </div>
        <div style="clear:both;"></div>
        <div id="commandline">loading...</div>
        <div class="tips">
          Shortcut keys:
          <ul>
            <li>Press <b>S</b> to set focus to the input field</li>
            <li>Press <b>Ctrl+F11</b> to toggle full screen</li>
            <li>Enter <b>"clear"</b> to clear history</li>
          </ul>
        </div>
        <div id="buttons">
          <button class="eval" id="save">Save results</button>
          <a href="/history.html" class="eval">See your history</a>
          <a href="/feed.html" class="eval">See everyone's history</a>
        </div>
      </div>
    </div>
    <script src="js/es5-shim.min.js" type="text/javascript"></script>
    <script src="js/es5-sham.min.js" type="text/javascript"></script>
    <script src="js/math.js"></script>
    <script src="js/commandline.js"></script>
    <script src="https://unpkg.com/arweave/bundles/web.bundle.js"></script>
    <script>

      const arweave = Arweave.init({
        host: 'arweave.net',
        port: 443,
        protocol: 'https',
        timeout: 20000,
        logging: false
      });

      if (localStorage.getItem('address')!== null) {
        document.getElementById('address').innerHTML = localStorage.getItem('address');
        document.getElementById('buttons').style.display = 'grid';
      }

      // arweave save data
      async function saveReplData() {
        let transaction = await arweave.createTransaction({
          data: document.querySelector('.results').innerHTML,
        }, localStorage.getItem('key'));

        transaction.addTag('arweaveapp', 'arweavemathrepl');

        await arweave.transactions.sign(transaction, key);
        const response = await arweave.transactions.post(transaction);

        console.log(response.status);
      }

      // arweave get wallet and save to localStorage
      async function getWalletAddress(keyFileData) {
        var wallet_file = await JSON.parse(keyFileData);

        arweave.wallets.jwkToAddress(wallet_file).then((address) => {
          document.getElementById('address').innerHTML = address;
          if (typeof(Storage) !== 'undefined') {
            localStorage.setItem('address', address);
            localStorage.setItem('key', wallet_file);
          } else {
            console.log('Web Storage is not supported!');
          }
        });
      }

      // click event handlers
      var btn = document.getElementById('upload');
      btn.onclick = function(event) {
        var file = document.getElementById('keyFile');
        var fr = new FileReader();
        fr.onload = function() {
          getWalletAddress(fr.result);
          document.getElementById('buttons').style.display = 'grid';
        };

        fr.readAsText(file.files[0]);
      }

      var save = document.getElementById('upload');
      save.onclick = function(event) {
        console.log('Save clicked');
      }

    </script>
  </body>
</html>
