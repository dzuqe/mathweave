<!DOCTYPE html>
<html>
  <head>
    <title>History</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/code.css">
    <link rel="stylesheet" href="css/commandline.css">
  </head>
  <body>
    <div id="page">
      <a href="/">Home</a>
      <a href="/history.html" class="selected">History</a>
      <a href="/feed.html">Feed</a>
      <div id="message">
        <h1>History<i>(latest 50)</i></h1>
      </div>
      <div id="history"></div>
    </div>
    <script src="https://unpkg.com/arweave/bundles/web.bundle.js"></script>
    <script>
      if (localStorage.getItem("address")!== null) {
        const address = localStorage.getItem('address');

        function replUIFactory(txid, data) {
          const element = `
            <a href="https://viewblock.io/arweave/tx/${txid}" target="_blank">${txid}</a>
            <div id="commandline">
              <div class="cle">
                <div class="top-panel">
                  <div class='results'>${data}
                </div>
              </div>
            </div>
          `;

          return element;
        }

        (async () => {
        
          const arweave = Arweave.init({
            host: "arweave.net",
            port: 443,
            protocol: "https",
            timeout: 20000,
            logging: false
          });


          const txids = await arweave.arql({
            op: "and",
            expr1: {
              op: "equals",
              expr1: "from",
              expr2: address,
            },
            expr2: {
              op: 'equals',
              expr1: 'arweaveapp',
              expr2: 'arweavemathrepl',
            }
          });

          const max = (txids.length >= 50) ? 50 : txids.length;
          for (var i = 0; i < max; i++) {
            const txid = txids[i];

            arweave
              .transactions
              .getData(txid, {decode: true, string: true})
              .then((data) => {
                document.getElementById('history').innerHTML += replUIFactory(txid, data);
              });
          }

        })();

      } else {
        console.log('no wallet!');
        document.getElementById('message').innerHTML = '<h1>You need to upload your keyfile first.'
      }
    </script>
  </body>
</html>
