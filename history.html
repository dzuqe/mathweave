<!DOCTYPE html>
<html>
  <head>
    <title>MathWeave - History</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/code.css">
    <link rel="stylesheet" href="css/commandline.css">
  </head>
  <body>
    <div id="page">
      <a href="/">Home</a>
      <a href="/history.html" class="selected">History</a>
      <a href="/feed.html">Feed</a>
      (ðŸ§½<a style="cursor: pointer; text-decoration: underline"  onClick="clearSession()">clear session</a>)
      <br/>
      <div id="update"></div>
      <div id="message">
        <h1>History<i>(latest 50)</i></h1>
      </div>
      <div id="history"></div>
    </div>
    <script src="https://unpkg.com/arweave/bundles/web.bundle.js"></script>
    <script src="js/utils.js"></script>
    <script>
      if (localStorage.getItem("address")!== null) {
        const address = localStorage.getItem('address');

        (async () => {
          const arweave = Arweave.init({
            host: "arweave.net",
            port: 443,
            protocol: "https",
            timeout: 20000,
            logging: false
          });

          const txids = await arweave.arql({
            op: "and",
            expr1: {
              op: "equals",
              expr1: "from",
              expr2: address,
            },
            expr2: {
              op: 'equals',
              expr1: 'arweaveapp',
              expr2: 'arweavemathrepl',
            }
          });

          const max = (txids.length >= 50) ? 50 : txids.length;
          for (var i = 0; i < max; i++) {
            const txid = txids[i];

            arweave
              .transactions
              .getData(txid, {decode: true, string: true})
              .then((data) => {
                document
                  .getElementById('history')
                  .innerHTML += replUIFactory(
                    txid, 
                    data, 
                    encodeData(data), 
                    document.getElementById('update')
                  );

              });
          }

        })();

      } else {
        document.getElementById('message').innerHTML = '<h1>You need to upload your keyfile first.'
      }
    </script>
  </body>
</html>
